{% extends "base.html" %}

{% block title %}Shopping Cart{% endblock %}

{% block sidebar_links %}
<a href="/home">Home</a>
<a href="/user_dashboard">User Dashboard</a>
<button type="button" onclick="toggleSidebar()">Close</button>
{% endblock %}

{% block content %}
<div class="cart-container">
    {% for item in data %}
    <div class="cart-item" data-stock="{{ item.stock }}" data-max-stock="{{ item.max_stock }}">
        <img src="{{ item.image }}" alt="{{ item.name }}">
        <div class="details">
            <h3>{{ item.name }}</h3>
            <p>Price per item: {{ item.price_per_unit }}/-</p>
            <div class="quantity-control">
                <p>Quantity:</p>
                <a href="/update_cart/{{ item.product_id }}/{{ user_id }}/decrease" class="cart-link decrease">-</a>
                <span class="quantity">{{ item.quantity }}</span>
                <a href="/update_cart/{{ item.product_id }}/{{ user_id }}/increase" class="cart-link increase">+</a>
            </div>
            <p class="price total-price">Total: {{ item.total_price }}/-</p>
        </div>
        <a href="/remove_cart_item/{{ item.product_id }}/{{ user_id }}" class="cart-link">
            <button>Remove</button>
        </a>
    </div>
    {% endfor %}
    <div class="total" id="grand-total">Grand Total: {{ total }}/-</div>
    <button class="checkout-btn" onclick="pay()">Proceed to Checkout</button>
</div>
{% endblock %}
{% block scripts %}
<script src="https://checkout.razorpay.com/v1/checkout.js" defer></script>
<script>

    function updateButtonStates(itemDiv, quantity) {
        const decBtn = itemDiv.querySelector('.decrease');
        const incBtn = itemDiv.querySelector('.increase');
        const maxStock = parseInt(itemDiv.dataset.maxStock);

        decBtn.style.cursor = quantity <= 1 ? 'not-allowed' : 'pointer';
        decBtn.style.pointerEvents = quantity <= 1 ? 'none' : 'auto';
        decBtn.style.opacity = quantity <= 1 ? '0.5' : '1';

        incBtn.style.cursor = quantity >= maxStock ? 'not-allowed' : 'pointer';
        incBtn.style.pointerEvents = quantity >= maxStock ? 'none' : 'auto';
        incBtn.style.opacity = quantity >= maxStock ? '0.5' : '1';
    }

    document.querySelectorAll('.cart-link').forEach(link => {
        link.addEventListener('click', function (e) {
            e.preventDefault();
            const itemDiv = this.closest('.cart-item');
            const quantitySpan = itemDiv.querySelector('.quantity');
            const totalPriceSpan = itemDiv.querySelector('.total-price');
            const grandTotalSpan = document.getElementById('grand-total');

            fetch(this.href, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        if (data.quantity !== undefined) {
                            quantitySpan.textContent = data.quantity;
                            totalPriceSpan.textContent = 'Total: ' + data.total_price + '/-';
                            grandTotalSpan.textContent = 'Grand Total: ' + data.grand_total + '/-';
                            itemDiv.dataset.stock = data.stock;
                            updateButtonStates(itemDiv, data.quantity);
                        } else {
                            itemDiv.remove();
                            grandTotalSpan.textContent = 'Grand Total: ' + data.grand_total + '/-';
                        }
                    }
                }).catch(err => console.error(err));
        });
    });

    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll('.cart-item').forEach(itemDiv => {
            const quantity = parseInt(itemDiv.querySelector('.quantity').textContent.trim());
            updateButtonStates(itemDiv, quantity);
        });
    });

    function pay() {
        const grandTotalText = document.getElementById('grand-total').textContent;
        const totalMatch = grandTotalText.match(/\d+/);
        const total = totalMatch ? parseInt(totalMatch[0]) : 0;

        if (!total || total <= 0) {
            alert("Cart is empty or invalid total.");
            return;
        }

        const options = {
            key: "rzp_test_RTMUKCN9huQkLG",
            amount: total * 100,
            currency: "INR",
            name: "Book Store",
            description: "Payment for Books",
            image: "{{ url_for('static', filename='images/logo.png') }}",
            handler: function (response) {
                fetch("/payment_success", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams({ razorpay_payment_id: response.razorpay_payment_id, userid: userId })
                }).then(() => window.location.href = "/user_dashboard")
                    .catch(err => console.error("Payment error:", err));
            },
            prefill: { contact: "+91 6301866127" },
            theme: { color: "green" }
        };

        const rzp = new Razorpay(options);
        rzp.on("payment.failed", function () { alert("Payment Failed!"); });
        rzp.open();
    }
</script>
{% endblock %}